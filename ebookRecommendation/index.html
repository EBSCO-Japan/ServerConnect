<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="Jay Chang">
    <title>EBSCO ebooks DDA Plus</title>

    <!-- Bootstrap core CSS -->
    <link href="assets/dist/css/bootstrap.css" rel="stylesheet">
    <link href="assets/dist/css/index.css" rel="stylesheet">
    <!-- Custom styles for this template -->
    <link href="form-validation.css" rel="stylesheet">
  </head>
  <body class="bg-light">
    <div id="mainTitle" class="mainTitle">
      <div class="lang-wrap">
        <div><img class="icon-star" src="assets/brand/icon/language.svg"></div>
        <select v-model="selector_lang" @change="setLang($event)">
          <option value="en">English</option>
          <option value="local">中文</option>
        </select>
      </div>
    </div>
    <div class="container">
      <div class="py-5 text-center">
        <img class="logo" src="assets/brand/eBooks_Logo.png" alt="">
      </div>
      <section id="formField">
        <div class="row">
          <div class="col-md-12 order-md-1">
            <h4 class="mb-3">{{$t('message.applying_userInfo_title')}}</h4>
              <div class="mb-3">
                <label>
                  {{$t('message.applying_userInfo_yourName')}}
                  <span class="text-muted">
                    <img class="icon-star" src="assets/brand/icon/star.svg">
                  </span>
                </label>
                <input type="text" class="form-control" v-model="formData.userInfo.name">
              </div>
              <div class="mb-3">
                <label>
                  {{$t('message.applying_userInfo_bussinessUnit')}}
                  <span class="text-muted">
                    <img class="icon-star" src="assets/brand/icon/star.svg">
                  </span>
                </label>
                <input type="text" class="form-control" v-model="formData.userInfo.userNumber">
              </div>
              <div class="row">
                <div class="col-md-12 mb-3">
                  <label>{{$t('message.applying_userInfo_capacity')}}</label>
                  <div class="row">
                    <div class="col-md-12">
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio1" value="staff" v-model="formData.userInfo.userIdentity">
                        <label class="form-check-label" for="radio1">{{$t('message.applying_options_staff')}}</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio2" value="doctoral" v-model="formData.userInfo.userIdentity">
                        <label class="form-check-label" for="radio2">{{$t('message.applying_options_doctoral')}}</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio3" value="postgraduate" v-model="formData.userInfo.userIdentity">
                        <label class="form-check-label" for="radio3">{{$t('message.applying_options_postgraduate')}}</label>
                      </div>
                      <div class="form-check form-check-inline">
                        <input class="form-check-input" type="radio" name="inlineRadioOptions" id="radio4" value="undergraduate" v-model="formData.userInfo.userIdentity">
                        <label class="form-check-label" for="radio4">{{$t('message.applying_options_postgraduate')}}</label>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
      
              <div class="mb-3">
                <label for="email">
                  {{$t('message.applying_userInfo_email')}}
                  <span class="text-muted">
                    <img class="icon-star" src="assets/brand/icon/star.svg">
                  </span>
                </label>
                <input type="email" class="form-control" id="email" v-model="formData.userInfo.email">
              </div>
      
              <div class="mb-3">
                <label for="faculty">{{$t('message.applying_userInfo_faculty')}}</label>
                <input type="text" class="form-control" id="faculty" v-model="formData.userInfo.faculty">
              </div>
      
              <div class="mb-3">
                <label for="phoneNum">{{$t('message.applying_userInfo_phone')}}</label>
                <input type="text" class="form-control" id="phoneNum" v-model="formData.userInfo.phone">
              </div>
              <hr class="mb-3">
              <h4 class="mt-3">{{$t('message.applying_ebookInfo_title')}}</h4>
              <div class="mt-3">
                <label for="firstName">
                  {{$t('message.applying_ebookInfo_isbn')}}
                  <span class="text-muted">
                    <img class="icon-star" src="assets/brand/icon/star.svg">
                  </span>
                </label>
                <input type="text" class="form-control" v-model="formData.purchaseInfo.isbn">
              </div>
              <div class="mt-3">
                <label for="firstName">{{$t('message.applying_ebookInfo_bookTitle')}}</label>
                <input type="text" class="form-control" v-model="formData.purchaseInfo.title">
              </div>
              <div class="mt-3">
                <label for="firstName">{{$t('message.applying_ebookInfo_publisher')}}</label>
                <input type="text" class="form-control" v-model="formData.purchaseInfo.publisher">
              </div>
              <div class="mt-3">
                <label for="firstName">{{$t('message.applying_ebookInfo_publishDate')}}</label>
                <input type="date" class="form-control" v-model="formData.purchaseInfo.date">
              </div>
              <hr class="mb-3">
              <h4 class="mt-3">{{$t('message.applying_ebookInfo_comment')}}</h4>
              <div class="mb-3">
                <div class="form-group">
                  <textarea class="form-control" rows="5" v-model="formData.note"></textarea>
                </div>
              </div>
              <hr class="mb-4">
              <div class="mt-3 remember-me-wrap">
                <label class="remember-me-title">
                  <input type="checkbox" id="checkbox_rememberMe" name="checkbox_rememberMe" v-model="formData.rememberUserInfo">
                  <div class="remember-me-wording">
                    {{$t('message.applying_remember_user_info')}}
                  </div>
                </label>
                <div class="remember-me-subtitle">{{$t('message.applying_remember_user_info_note')}}</div>
              </div>
              <button class="btn btn-primary btn-lg btn-block" @click="submit">{{$t('message.applying_submit')}}</button>
          </div>
        </div>
      </section>
      <!-- <div class="pt-5 text-center">
        <h5>关于版权限制的警告</h5>
        <p class="text-small">
          美国的版权法（美国法典第17篇）管理着作权材料的复印件或其他复制品的制作。在法律规定的某些条件下，图书馆和档案馆有权提供复印件或其他复制品。其中一个特定的条件是复印或复制不是以“私人学习，奖学金或研究以外的任何目的”。如果用户为了超出“合理使用”的目的而提出要求，或稍后使用影印或复制，则该用户可能会对版权侵权承担责任。 如果判定该命令的履行会涉及违反版权法，则该机构保留拒绝复制的权利。
        </p>
      </div> -->
      <footer class="my-5 text-muted text-center text-small">
        <p class="mb-1">&copy; 2020 EBSCO Information Services, Inc.</p>
        <!-- <ul class="list-inline">
          <li class="list-inline-item"><a href="#">Privacy</a></li>
          <li class="list-inline-item"><a href="#">Terms</a></li>
          <li class="list-inline-item"><a href="#">Support</a></li>
        </ul> -->
      </footer>
    </div>

    <div id="dialogue" class="mask" v-if="show" :class="{ show: show }">
      <!-- <div class="cover" @click="closeDialogue"></div> -->
      <div class="dialogue-message-frame" v-if="type === 'notFillAll'">
        <div class="dialogue-head">
          <h4>{{$t('message.dialogue_title_error')}}</h4>
        </div>
        <div class="dialogue-body">
          {{$t('message.dialogue_content_fillAllBlank')}}
          <div class="btn-frame">
            <button @click="close('dialogue')">{{$t('message.button_close')}}</button>
          </div>
        </div>
      </div>
      <div class="dialogue-message-frame" v-if="type === 'success'">
        <div class="dialogue-head">
          <h4>{{$t('message.dialogue_title_success')}}</h4>
        </div>
        <div class="dialogue-body">
          {{$t('message.dialogue_content_applicationHasBeenReceived')}}
          <div class="btn-frame">
            <button @click="close('window')">{{$t('message.button_close')}}</button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script>window.jQuery || document.write('<script src="assets/js/vendor/jquery.slim.min.js"><\/script>')</script>
    <script src="assets/dist/js/bootstrap.bundle.js"></script>
    <script src="form-validation.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.10/dist/vue.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue-i18n/8.15.3/vue-i18n.min.js"></script>
    <script src="lang/lang.js"></script>
  </body>
</html>
<script>
  var mainTitle = new Vue({
    el:'#mainTitle',
    i18n,
    data: {
      selector_lang: '',
      show: true
    },
    created: function() {
    },
    mounted: function() {
      this.selector_lang = i18n.locale;
    },
    methods: {
      async setLang(event) {
        i18n.locale = event.target.value;
      }
    }
  })
  var dialogue = new Vue({
    el:'#dialogue',
    i18n,
    data: {
      show: false,
      type: ''
    },
    methods:{
      setDialogue: function(type = '') {
        this.type = type;
        this.show = true;
      },
      close: function(type) {
        if(type === 'dialogue') {
          this.show = false;
        } else if(type === 'window'){
          // for open by script and direct open window
          if(window.opener === null) {
            this.show = false;
          } else {
            window.close();
          }
        }
      }
    }
  });
  var formField = new Vue({
    el:'#formField',
    i18n,
    data: {
      client: '',
      formData: {
        userInfo: {
          name: '',
          userNumber: '',
          userIdentity: '',
          email: '',
          faculty: '',
          phone: ''
        },
        purchaseInfo: {
          isbn: '',
          title: '',
          publisher: '',
          date: ''
        },
        note: '',
        an: '',
        dbCode: '',
        rememberUserInfo: false
      }
    },
    created: function() {
      // example: https://gss.ebscohost.com/chchang/ServerConnect/ebookRecommendation/index.html?client=ns055233_ebooks&lng=1&title=%E3%82%AD%E3%83%A3%E3%83%83%E3%82%B7%E3%83%A5%E3%83%AC%E3%82%B9%E7%B5%8C%E6%B8%88&aulast=&publisher=%E6%96%87%E7%9C%9E%E5%A0%82&date=20180101&isbn=9784830950018&sid=EBSCO:edsebk&an=2395336&dbCode=edsebk
      // http://search.ebscohost.com/login.aspx?authtype=uid&profile=eds-dda&user=bnu&password=LibUse@2020

      // check the localstorage has value or not
      this.checkLocalstorageValue();

      const paramTable = ['client','lng','title','aulast','publisher','date','isbn','sid','an','dbCode']
      let url_string = window.location.href;
      let url = new URL(url_string);

      for(index in paramTable) {
        let paramVal = url.searchParams.get(paramTable[index]);

        if(paramVal !== null) {
          switch(paramTable[index]) {
            case 'client':
              this.client = paramVal;
              break;
            case 'title':
              this.formData.purchaseInfo.title = paramVal;
              break;
            case 'publisher':
              this.formData.purchaseInfo.publisher = paramVal;
              break;
            case 'date':
              let dateOutput = [paramVal.slice(0, 4), '-', paramVal.slice(4, 6), '-', paramVal.slice(6)].join('');
              console.log(dateOutput);
              this.formData.purchaseInfo.date = dateOutput;
              break;
            case 'isbn':
              this.formData.purchaseInfo.isbn = paramVal;
              break;
            case 'an':
              this.formData.an = paramVal;
              break;
            case 'dbCode':
              this.formData.dbCode = paramVal;
              break;
          }
        }
      }
    },
    methods:{
      checkUserInfoStatus() {
        if(this.formData.rememberUserInfo) {
          localStorage.setItem('rememberUserInfo', JSON.stringify(this.formData.rememberUserInfo));
          localStorage.setItem('userInfo', JSON.stringify(this.formData.userInfo));
        } else {
          // remove localstorage data
          if("rememberUserInfo" in localStorage) {
            localStorage.removeItem('rememberUserInfo');
          }

          if("userInfo" in localStorage) {
            localStorage.removeItem('userInfo');
          }
        }
      },
      checkLocalstorageValue() {
        let tempUserInfo = '';
        // get checkbox info
        if("rememberUserInfo" in localStorage) {
          this.formData.rememberUserInfo = JSON.parse(localStorage.getItem('rememberUserInfo'));
        }

        // if local storage has value, get the value and put into the text box
        if("userInfo" in localStorage) {
          tempUserInfo = JSON.parse(localStorage.getItem('userInfo'));

          Object.keys(tempUserInfo).forEach(key => {
            if(key in this.formData.userInfo) {
              this.formData.userInfo[key] = tempUserInfo[key];
            }
          });
        }
      },
      checkFill() {
        if(this.formData.userInfo.name.trim() === '' || this.formData.userInfo.userNumber.trim() === '' || this.formData.userInfo.email.trim() === '' || this.formData.purchaseInfo.isbn.trim() === '') {
          return false;
        } else {
          return true;
        }
      },
      submit() {
        this.checkUserInfoStatus();
        let formPass = this.checkFill();
        if(formPass) {
          let self = this;
          $.ajax({
            url: 'https://gss.ebscohost.com/chchang/ServerConnect/ebookRecommendation/features/processEbookRequirement.php',
            type: 'POST',
            data: {
              type: 'add',
              formData: JSON.stringify(self.formData)
            },
            error: function(jqXHR, exception) {
              //use url variable here
              console.log(jqXHR);
              console.log(exception);
            },
            success: function(res) {
              console.log(res);
              dialogue.setDialogue('success');
            }
          });
        } else {
          dialogue.setDialogue('notFillAll');
        }
      }
    }
  });
</script>
